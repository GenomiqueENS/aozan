<?xml version="1.0" encoding="UTF-8"?>
<!-- 
/*
 *                  Aozan development code
 *
 * This code may be freely distributed and modified under the
 * terms of the GNU General Public License version 3 or later 
 * and CeCILL. This should be distributed with the code. If you 
 * do not have a copy, see:
 *
 *      http://www.gnu.org/licenses/gpl-3.0-standalone.html
 *      http://www.cecill.info/licences/Licence_CeCILL_V2-en.html
 *
 * Copyright for this code is held jointly by the Genomic platform
 * of the Institut de Biologie de l'École Normale Supérieure and
 * the individual authors. These should be listed in @author doc
 * comments.
 *
 * For more information on the Aozan project and its aims,
 * or to join the Aozan Google group, visit the home page at:
 *
 *      http://www.transcriptome.ens.fr/aozan
 *
 */
-->
<document>

  <properties>
    <title>QC samples tests</title>
    <author email="jourdren@biologie.ens.fr">Laurent Jourdren</author>
  </properties>

  <body>
    
    <section name="Quality control samples tests">
    
     <p>User can add samples tests to perform in this steps. The order of the parameters in the Aozan configuration
     file will be reused in the report generated by this step.  Each test can use 
     several parameters and contains always an "<b>enable</b>" property to activate the test. Usually a property named "<b>interval</b>" exists 
     for each test, however if this property is not set, the value will be computed but not checked if it is the correct interval.
     You will find below all the parameters for all the available tests in Aozan.</p>
     
       
       <p>For the quality control sample test, the report brings together three source of data :</p>
       <ul>
       		<li><p><a href="#data_illumina">Data supplied by the demultiplexing step</a></p></li>
       		<li><p><a href="#fastqc">FastQC</a></p></li>
       		<li><p><a href="#contamination">Contamination detection</a></p></li>
       </ul>
       
       <a name="data_illumina"/>
       <subsection name="Sample quality tests from demultiplexing step">
       <table>
         <tr><th>Aozan property</th><th>Type</th><th>Default value</th><th>description</th></tr>
         <tr><td>qc.test.rawclusterssamples.enable</td><td>boolean</td><td>False</td><td>Enable rawclusterssamples test</td></tr>
         <tr><td>qc.test.rawclusterssamples.interval</td><td>integer interval</td><td>False</td><td>Interval for valid values of rawclusterssamples</td></tr>
         <tr><td>qc.test.pfclusterssamples.enable</td><td>boolean</td><td>False</td><td>Enable pfclusterssamples test</td></tr>
         <tr><td>qc.test.pfclusterssamples.interval</td><td>integer interval</td><td>False</td><td>Interval for valid values of pfclusterssamples</td></tr>
         <tr><td>qc.test.percentpfsample.enable</td><td>boolean</td><td>False</td><td>Enable percentpfsample test</td></tr>
         <tr><td>qc.test.percentpfsample.interval</td><td>double interval</td><td>False</td><td>Interval for valid values of percentpfsample</td></tr>                  
         <tr><td>qc.test.percentinlanesample.enable</td><td>boolean</td><td>False</td><td>Enable percentinlanesample test</td></tr>
         <tr><td>qc.test.percentinlanesample.interval</td><td>double interval</td><td>False</td><td>Interval for valid values of percentinlanesample</td></tr>
         <tr><td>qc.test.percentq30.enable</td><td>boolean</td><td>False</td><td>Enable percentq30 test</td></tr>
         <tr><td>qc.test.percentq30.interval</td><td>double interval</td><td>False</td><td>Interval for valid values of percentq30</td></tr>
         <tr><td>qc.test.meanqualityscorepf.enable</td><td>boolean</td><td>False</td><td>Enable meanqualityscorepf test</td></tr>
         <tr><td>qc.test.meanqualityscorepf.interval</td><td>double interval</td><td>False</td><td>Interval for valid values of meanqualityscorepf</td></tr>     
       </table>  
       <p>The explanation to construct intervals is <a href="#syntax_interval">here.</a></p>
       </subsection>
       
       <a name="fastqc"/>
       <subsection name="Sample quality tests from FastQC">
       <p> Aozan launch <a href="http://www.bioinformatics.babraham.ac.uk/projects/fastqc/" target="_blank">FastQC</a> on each sample (using parallel computation) and creates a report file including the thresholds fixed for quality controls.
    	It contains an additional FastQC step named "<b>Bad tiles</b>" that search tiles with BMS (&quot;Bottom Middle Swath&quot;) issues with Illumina flowcell v3.</p>
     
       <table>
         <tr><th>Aozan property</th><th>Type</th><th>Default value</th><th>description</th></tr>
         <tr><td>qc.test.basicstats.enable</td><td>boolean</td><td>False</td><td>Enable FastQC basicstats test</td></tr>
         <tr><td>qc.test.perbasequalityscores.enable</td><td>boolean</td><td>False</td><td>Enable FastQC perbasequalityscores test</td></tr>
         <tr><td>qc.test.persequencequalityscores.enable</td><td>boolean</td><td>False</td><td>Enable FastQC persequencequalityscores test</td></tr>
         <tr><td>qc.test.perbasesequencecontent.enable</td><td>boolean</td><td>False</td><td>Enable FastQC perbasesequencecontent test</td></tr>
         <tr><td>qc.test.perbasegccontent.enable</td><td>boolean</td><td>False</td><td>Enable FastQC perbasegccontent test</td></tr>
         <tr><td>qc.test.perSequencegccontent.enable</td><td>boolean</td><td>False</td><td>Enable FastQC perSequencegccontent test</td></tr>
         <tr><td>qc.test.ncontent.enable</td><td>boolean</td><td>False</td><td>Enable FastQC ncontent test</td></tr>
         <tr><td>qc.test.sequencelengthdistribution.enable</td><td>boolean</td><td>False</td><td>Enable FastQC sequencelengthdistribution test</td></tr>
         <tr><td>qc.test.duplicationlevel.enable</td><td>boolean</td><td>False</td><td>Enable FastQC duplicationlevel test</td></tr>
         <tr><td>qc.test.overrepresentedseqs.enable</td><td>boolean</td><td>False</td><td>Enable FastQC overrepresentedseqs test</td></tr>
         <tr><td>qc.test.kmercontent.enable</td><td>boolean</td><td>False</td><td>Enable FastQC kmercontent test</td></tr>
         <tr><td>qc.test.badtiles.enable</td><td>boolean</td><td>False</td><td>Enable FastQC badtiles test</td></tr>
    	</table>

    <p>If no FastQC test property is set, FastQC will not be launch on FastQ data.</p>
       
    <p>An example of table built with sample quality tests</p>
    <div align="center">
    	<table><tr><th align="center"><img src="images/qc_sample_test.png" alt="" border="1"></img></th></tr></table>
    </div>
    </subsection>
     <a name="contamination"/>
     <subsection name="Sample quality tests from the contamination detection">
     <p>Uses the principles from FastQ Screen. 
	    Maps reads on a list of reference genomes for assessing sample contamination and on the genome of the sample.
    	Creates a report file with values for each genome
     </p>
    		<p>This step assesses the sample contamination from the fastq files. To do Aozan uses the principles from 
			<a href="http://www.bioinformatics.babraham.ac.uk/projects/fastq_screen/"  target="_blank">FastQ Screen</a>. 
			FastQ Screen allows to screen a library of sequences in Fastq format against a set of sequence databases. </p>
			
			<p>The code has been rewriting in Aozan and additional values have been creating.
			Here we use <a href="http://bowtie-bio.sourceforge.net/manual.shtml"  target="_blank">bowtie</a> to align reads 
			to reference genomes or contaminant databases like adapter sequences, PhiX and <a href="http://www.arb-silva.de/no_cache/download/archive/release_111/Exports">ribosomes databases</a>.
			Moreover it aligns on the genome of the sample based on the data in the casava sample-sheet file.
			</p>

			<p>Currently all the reads are aligned. The runtime is very long, even with the multithreading option of bowtie. 
			The list of reference genomes is limited to the essential.
			<!-- For reduce the runtime, if necessary, the fastq files are prepared in multithreading mode. -->
			For reduce the runtime, several choices have been made :</p>
				<p><ul><li>create a partial fastq file for each sample for this step : 200 000 reads pf (passing illumina filters), selected at regular interval.
							It's enough for estimate the contamination in a sample.</li>
					<li>browse the beginning of initial file for create partial fastq file, the duration of creation fastq file is not too extended without lost information.</li></ul></p>
			 
			<p>After, the align on reference genomes is launched. At the end, all temporary fastq files are removed.</p>
			
			<h5>General configuration for launch the mapper.</h5>
			<p>Aozan uses the development in other framework from the platform, 
			<a href="http://transcriptome.ens.fr/eoulsan"  target="_blank">Eoulsan, </a>for handle automatically the alignment. 
			<a href="http://transcriptome.ens.fr/eoulsan/datarepositories.html" target="_blank">More details in this page.</a>
			</p>
			
			<table>
			  <tr><th>Aozan property</th><th>Type</th><th>Default value</th><th>Description</th></tr>
			  <tr><td>qc.conf.genome.alias.path</td><td>string</td>
				  <td>NA</td>
				  <td>Path to the file which make the correspondence between genome name in casava design file and the genome name reference used for
						identified index of bowtie. If a genome's name doesn't exist in the alias file, it's added at the end. </td></tr>
			  <tr><td>qc.conf.settings.genomes.desc.path</td><td>string</td>
				  <td>NA</td>
				  <td>Path to the genomes descriptions repository. The genome description file contains some basic informations about the genome
						like the chromosome length. The repository allow to avoid useless genome sequence parsing once it has been already parsed in a
						previous run. </td></tr>
			  <tr><td>qc.conf.settings.genomes</td><td>string</td><td>NA</td><td>Path to the genomes repository.</td></tr>
 			  <tr><td>qc.conf.settings.mappers.indexes.path</td><td>string</td><td>NA</td><td>Path to the genomes indexes repository.</td></tr>
			  <tr><td>qc.conf.fastqscreen.genomes</td><td>string</td><td>phix, adapters</td><td>List of reference genomes used per default for fastqscreen.</td></tr>
			  <tr>
				<td>qc.conf.skip.control.lane</td>
				<td>boolean</td>
				<td>True</td>
				<td>No of contamination detection on control lane.</td>
			  </tr>
			  <tr>
				<td>qc.conf.ignore.paired.mode</td>
				<td>boolean</td>
				<td>True</td>
				<td>For a run paired-end, the detection contamination concerns only the reads R1, same value are assigned for reads R2 
					It's 'False' the mapping is paired mode with reads R1 and  R2.</td>
			  </tr>
			  <tr>
				<td>qc.conf.max.reads.parsed</td>
				<td>integer</td>
				<td>200000</td>
				<td>Number of reads included in temporary fastq files create for this step. 
					Only the reads with passing filtered illumina are selected. It's equal to -1, all reads in fastq files used.</td>
			  </tr>
			  <tr>
				<td>qc.conf.reads.pf.used</td>
				<td>integer</td>
				<td>30000000</td>
				<td>Part of fastq files in number of reads used for create the fastq files. It's equal to -1, it browses fastq files fully.</td>
			  </tr>
			  
			</table>

			<H5>Configuration tests</H5>

			<table>
				<tr>
					<th>Aozan property</th>
					<th>Type</th>
					<th>Default value</th>
					<th>Description</th>
				</tr>
				<tr>
					<td>qc.test.hitnolibraries.enable</td>
					<td>boolean</td>
					<td>False</td>
					<td>The report of quality control contains a column with the percent 
					of reads mapped at least one reference genomes, except on genome sample test</td>
				</tr>
				<tr>
					<td>qc.test.hitnolibraries.interval</td>
					<td>double interval</td>
					<td>[0, 0.1]</td>
					<td>Interval of valid values</td>
				</tr>
				<tr>
					<td>qc.test.fsqmapped.enable</td>
					<td>boolean</td>
					<td>False</td>
					<td>The report of quality control contains a column with the percent
					 of reads mapped for each reference genome test.</td>
				</tr>
				<tr>
					<td>qc.test.fsqmapped.interval</td>
					<td>double interval</td>
					<td>[0, 0.1]</td>
					<td>Interval of valid values. If the genome is this of sample, the interval is reverse (ex: [0.9, 1])</td>
				</tr>

				<tr>
					<td>qc.test.linkreport.enable</td>
					<td>boolean</td>
					<td>False</td>
					<td>The report of quality control contains a column with link to report fastqscreen file, 
						save in quality control directory.</td>
				</tr>
			</table>	
		<p>The explanation to construct intervals is <a href="#syntax_interval">here.</a></p>
                <p>If no FastQ Screen test property is set, FastQ Screen will not be launch on FastQ data.</p>
       
        <p>The last column contains a link to the report html fastqscreen. An example of a report html of quality control with major values of fastqscreen : 
		<div align="center">
			<table><tr><th align="center"><img src="images/tab_fastqscreen.png" alt="" border="1"></img></th></tr></table>
		</div>
		</p>
		
		<p>An example of a report html fastqscreen with four reference genomes and the genome sample (hg19) :
		<div align="center">
			<table><tr><th align="center"><img src="images/report_html_fastqscreen.png" alt="" border="1"></img></th></tr></table>
		</div></p>
		<p>The report exists in csv format.</p>
		
		<p>List of values for each genome :
		<ul>
			<li><b>%Mapped</b> : percent of reads which are mapped on this genome. It must be low for the genome reference of contamination and big for the genome of the sample).</li>
			<li><b>%Unmapped</b> : percent of reads which are not mapped on this genome.</li>
			<li><b>%One_hit_one_library</b> : percent of reads which are mapped with one hit on one genome.</li>
			<li><b>%Multiple_hits_one_library</b> : percent of reads which are multi-mapped on this genome.</li>
			<li><b>%One_hit_multiple_libraries</b> : percent of reads which are mapped with one hit on several genomes.</li>
			<li><b>%Multiple_hits_multiple_libraries</b> : percent of reads which are multi-mapped on several genomes.</li>
		</ul></p>
	<p>NB : The genome of the sample serves the positif temoin.
	</p>

	<p>List of values for all genomes :
	<ul>
		<li><b>% reads_unmapped_none_genome</b> : percent of reads which are not mapped on none genomes tested. It must be big if the genome of the sample isn't used and low if it is used).</li> 
		<li><b>% reads_mapped_at_least_one_genome</b> : percent of reads which are mapped on at least one genome.</li>
		<li><b>% reads_mapped_except_genome_sample</b> : percent of reads which are mapped on the genomes references of contamination, the genome of the sample is excluded.</li>
		<li> X reads mapped / 200 000 reads processed </li>
	</ul>
	</p>
    </subsection>
    
    <a name="syntax_interval"/>
    <subsection name="Syntax of the interval value">
    
    <p>User can define intervals as the next examples:</p>
    <ul>
      <li><b>[,10]</b> From - infinite to 10 (included)</li>
      <li><b>[,10[</b> From - infinite to 10 (excluded)</li>
      <li><b>[,10)</b> From - infinite to 10 (excluded)</li>
      <li><b>]2,10[</b> From 2 (excluded) to 10 (excluded)</li>
      <li><b>(2,10[</b> From 2 (excluded) to 10 (excluded)</li>
      <li><b>[2,10]</b> From 2 (included) to 10 (included)</li>
      <li><b>[2,]</b> From 2 (included) to + infinite</li>      
    </ul>      
    </subsection>
    </section>
  </body>
</document>
